name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        run: |
          if [ -z "${{ steps.prev_tag.outputs.tag }}" ]; then
            COMMITS=$(git log --pretty=format:"%s|%h" --no-merges)
          else
            COMMITS=$(git log ${{ steps.prev_tag.outputs.tag }}..HEAD --pretty=format:"%s|%h" --no-merges)
          fi

          # Initialize sections
          FEATURES=""
          FIXES=""
          BREAKING=""
          SECURITY=""
          OTHER=""

          while IFS='|' read -r message hash; do
            # Skip empty, whitespace-only, typo fixes, and trivial commits
            [[ -z "$message" ]] && continue
            [[ "$message" =~ ^[[:space:]]*$ ]] && continue
            [[ "$message" =~ ^(typo|fix[[:space:]]typo|whitespace|formatting|lint|style:|chore\(deps\)|bump|wip|temp|todo) ]] && continue
            [[ "$message" =~ ^(Merge|Initial commit) ]] && continue
            [[ ${#message} -lt 10 ]] && continue

            # Categorize commits by conventional commit prefix or keywords
            if [[ "$message" =~ ^feat(\(|:|\!) ]] || [[ "$message" =~ (add|implement|new|feature|support) ]]; then
              FEATURES="$FEATURES\n- $message"
            elif [[ "$message" =~ ^fix(\(|:) ]] || [[ "$message" =~ (fix|bug|patch|resolve|correct) ]]; then
              FIXES="$FIXES\n- $message"
            elif [[ "$message" =~ ^(BREAKING|breaking|!) ]] || [[ "$message" =~ (breaking change|remove|deprecate) ]]; then
              BREAKING="$BREAKING\n- $message"
            elif [[ "$message" =~ (security|vulnerability|CVE|auth) ]]; then
              SECURITY="$SECURITY\n- $message"
            else
              OTHER="$OTHER\n- $message"
            fi
          done <<< "$COMMITS"

          # Build changelog
          CHANGELOG=""

          if [ -n "$BREAKING" ]; then
            CHANGELOG="$CHANGELOG## âš ï¸ Breaking Changes\n$BREAKING\n\n"
          fi

          if [ -n "$SECURITY" ]; then
            CHANGELOG="$CHANGELOG## ðŸ”’ Security\n$SECURITY\n\n"
          fi

          if [ -n "$FEATURES" ]; then
            CHANGELOG="$CHANGELOG## âœ¨ New Features\n$FEATURES\n\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="$CHANGELOG## ðŸ› Bug Fixes\n$FIXES\n\n"
          fi

          if [ -n "$OTHER" ]; then
            CHANGELOG="$CHANGELOG## ðŸ“ Other Changes\n$OTHER\n\n"
          fi

          # Default message if no categorized commits
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Minor improvements and updates."
          fi

          # Save to file for multiline support
          echo -e "$CHANGELOG" > changelog.md
          echo "Generated changelog:"
          cat changelog.md

          # Use file output for multiline
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.md

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: amd64
          - os: macos-latest
            platform: darwin
            arch: amd64
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: ubuntu-22.04
            platform: linux
            arch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Add NSIS to PATH
        if: matrix.platform == 'windows'
        run: echo "C:\Program Files (x86)\NSIS" >> $GITHUB_PATH
        shell: bash

      - name: Build for Windows
        if: matrix.platform == 'windows'
        run: wails build -clean -nsis -platform windows/amd64 -ldflags "-X main.Version=${{ github.ref_name }}" -v 2
        shell: bash

      - name: Build for macOS (amd64)
        if: matrix.platform == 'darwin' && matrix.arch == 'amd64'
        run: wails build -clean -platform darwin/amd64 -ldflags "-X main.Version=${{ github.ref_name }}"

      - name: Build for macOS (arm64)
        if: matrix.platform == 'darwin' && matrix.arch == 'arm64'
        run: wails build -clean -platform darwin/arm64 -ldflags "-X main.Version=${{ github.ref_name }}"

      - name: Build for Linux
        if: matrix.platform == 'linux'
        run: wails build -clean -platform linux/amd64 -ldflags "-X main.Version=${{ github.ref_name }}"

      - name: Package Windows
        if: matrix.platform == 'windows'
        run: |
          Get-ChildItem build\bin
          $installer = Get-ChildItem build\bin\*installer.exe | Select-Object -First 1
          if ($installer) {
            Move-Item $installer.FullName build\bin\farmland-windows-amd64-installer.exe -Force
            Write-Host "Installer packaged: build\bin\farmland-windows-amd64-installer.exe"
          } else {
            Write-Warning "No installer found! This build may have failed to trigger NSIS."
            # Fallback for debugging: if only exe exists, rename it (though it's not an installer)
            if (Test-Path build\bin\farmland.exe) {
              Write-Host "Found farmland.exe, but no installer."
            }
            exit 1
          }
        shell: pwsh

      - name: Package macOS
        if: matrix.platform == 'darwin'
        run: |
          cd build/bin
          zip -r farmland-${{ matrix.platform }}-${{ matrix.arch }}.zip farmland.app

      - name: Install NFPM
        if: matrix.platform == 'linux'
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm

      - name: Generate NFPM Config
        if: matrix.platform == 'linux'
        run: |
          mkdir -p build/linux
          ls -d build/linux
          cat > build/linux/nfpm.yaml <<EOF
          name: "farmland"
          arch: "amd64"
          platform: "linux"
          version: "${{ github.ref_name }}"
          section: "utils"
          priority: "extra"
          maintainer: "Daniel Togey <dannykosgei@gmail.com>"
          description: "Modern Farm Management System"
          vendor: "Farmland"
          homepage: "https://github.com/danielkosgei/farmland"
          license: "MIT"
          contents:
            - src: "../../build/bin/farmland"
              dst: "/usr/bin/farmland"
          EOF
        shell: bash

      - name: Package Linux (.deb & .rpm)
        if: matrix.platform == 'linux'
        run: |
          cd build/linux
          nfpm pkg --target ../bin/farmland-linux-amd64.deb
          nfpm pkg --target ../bin/farmland-linux-amd64.rpm
        shell: bash

      - name: Package Linux (tar.gz)
        if: matrix.platform == 'linux'
        run: |
          cd build/bin
          tar -czvf farmland-linux-amd64.tar.gz farmland

      - name: Upload Windows artifact
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: farmland-windows-amd64-installer
          path: build/bin/farmland-windows-amd64-installer.exe

      - name: Upload macOS artifact
        if: matrix.platform == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: farmland-${{ matrix.platform }}-${{ matrix.arch }}
          path: build/bin/farmland-${{ matrix.platform }}-${{ matrix.arch }}.zip

      - name: Upload Linux artifact
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: farmland-linux-amd64
          path: |
            build/bin/farmland-linux-amd64.tar.gz
            build/bin/farmland-linux-amd64.deb
            build/bin/farmland-linux-amd64.rpm

  release:
    needs: [changelog, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ needs.changelog.outputs.changelog }}
          files: |
            artifacts/farmland-windows-amd64-installer/farmland-windows-amd64-installer.exe
            artifacts/farmland-darwin-amd64/farmland-darwin-amd64.zip
            artifacts/farmland-darwin-arm64/farmland-darwin-arm64.zip
            artifacts/farmland-linux-amd64/farmland-linux-amd64.tar.gz
            artifacts/farmland-linux-amd64/farmland-linux-amd64.deb
            artifacts/farmland-linux-amd64/farmland-linux-amd64.rpm
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
